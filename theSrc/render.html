<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="styles/main.css">
  </head>
  <body>
    <!-- TEMPLATE These are specific for your project and must be updated -->
    <script src="external/lodash.min.js"></script>
    <script src="external/jquery.min.js"></script>
    <script src="external/d3.min.js"></script>

    <a href="/" class="prev-link" style="display:none">Prev</a>
    <a href="/">Back to Examples</a>
    <a href="/" class="next-link" style="display:none">Next</a>
    <h2 class="name" style="font-family:verdana"></h2>

    <div class="scenario" style="font-weight:600;font-family:verdana;padding-left:20px;"></div>

    <div class="outer-wrapper" style="padding-top:10px">
      <div class="content-window"></div>
    </div>

    <h3 style="font-family:verdana">Settings:</h2>
    <div class="settings-container">
      <div style="padding-left:20px">Width: <span class="width"></span></div>
      <div style="padding-left:20px">Height: <span class="height"></span></div>
      <pre style="padding-left:20px" class="settings"></pre>
    </div>

    <form id="resize-form" style="padding-top:10px" >
      <label for="width-input">New Width:</label>
      <input type="text" id="width-input" class="width-input" value="200"></input>
      <label for="height-input">New Height:</label>
      <input type="text" id="height-input" class="height-input" value="200"></input>
      <button class="resize-button">Resize</button>
    </form>

    <!-- NB This script should be defined before rhtmlTemplate.js is loaded-->
    <script>
      function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
          }
        }
        console.log('Query variable %s not found', variable);
      }

      myWidgetDefinition = null;
      myWidgetInstance = null

      // This is a stub that will capture the widget definition,
      // so that we can use it once the page finishes loading
      HTMLWidgets = {
        widget: function(widgetDefinition) {
          console.log("widget create called!");
          myWidgetDefinition = widgetDefinition;
        }
      };

      $(document).ready( function() {
        console.log("Document ready. Fetching scenarios");

        $('#resize-form').bind('submit', function(event) {
          event.preventDefault();
          console.log("resize submit");

          width = $('#width-input').val();
          height = $('#height-input').val();

          outerWrapper = $('.outer-wrapper')
            .css('width', width)
            .css('height', height)

          container = $('.content-window')

          myWidgetDefinition.resize(container, width, height, myWidgetInstance);

          return false;
        });

        var featureFileLocation = './resources/data/';
        var featureFile = getQueryVariable('featureFile') || 'features.json';

        $.ajax(featureFileLocation + featureFile).done(function (response) {
          console.log("Scenario retrieved. Instantiating captured widget");

          var featureIndex = parseInt(getQueryVariable('featureIndex'));
          var featureLength = response.features.length;
          var feature = response.features[featureIndex];

          var scenarioIndex = parseInt(getQueryVariable('scenarioIndex'));
          var scenarioLength = feature.scenarios.length;
          var scenario = feature.scenarios[scenarioIndex];

          getNext = function() {
            thereIsMoreScenarios = function () {
              return (scenarioIndex + 1 < scenarioLength);
            }

            thereIsMoreFeatures = function () {
              return (featureIndex + 1 < featureLength);
            }

            if (thereIsMoreScenarios()) {
              return {
                feature: featureIndex,
                scenario: scenarioIndex + 1
              }
            }

            else if (thereIsMoreFeatures()) {
              return {
                feature: featureIndex + 1,
                scenario: 0
              }
            }

            // NB wrap around case
            return {
              feature: 0,
              scenario: 0
            };
          }

          getPrev = function() {
            thereIsPreviousScenarios = function () {
              return (scenarioIndex > 0);
            }

            thereIsPreviousFeatures = function () {
              return (featureIndex > 0);
            }

            previousScenarioLength = function () {
              return response.features[featureIndex-1].scenarios.length - 1;
            }

            if (thereIsPreviousScenarios()) {
              return {
                feature: featureIndex,
                scenario: scenarioIndex - 1
              }
            }

            else if (thereIsPreviousFeatures()) {
              return {
                feature: featureIndex - 1,
                scenario: previousScenarioLength()
              }
            }

            //NB Wrap around case
            lastFeatureIndex = response.features.length - 1,
            lastFeature = response.features[lastFeatureIndex]
            lastScenarioIndex = lastFeature.scenarios.length - 1
            return {
              feature: lastFeatureIndex,
              scenario: lastScenarioIndex
            };
          }

          makeLink = function(args) {
            if (!args) { return null; }
            return 'render.html?featureIndex=' + args.feature + '&scenarioIndex=' + args.scenario;
          }

          prevLink = makeLink(getPrev());
          nextLink = makeLink(getNext());

          if (prevLink) {
            $('.prev-link').attr('href', prevLink).css('display', 'inline-block');
          }
          if (nextLink) {
            $('.next-link').attr('href', nextLink).css('display', 'inline-block');
          }

          $("body").keydown(function(e){
              var leftKey = 37;
              var rightKey = 39;
              if (prevLink && (e.keyCode || e.which) == leftKey) { window.location = prevLink; }
              if (nextLink && (e.keyCode || e.which) == rightKey) { window.location = nextLink; }
          });

          $('.name').text(scenario.name);
          $('.width').text(scenario.width);
          $('.height').text(scenario.height);
          _.forEach(scenario.description, function(descriptionLine) {
            textLine = $('<p>').text(descriptionLine);
            $('.scenario').append(textLine);
          });
          $('.settings').text(JSON.stringify(scenario.settings, {}, 2));

          outerWrapper = $('.outer-wrapper')
          container = $('.content-window')

          myWidgetInstance = myWidgetDefinition.initialize(container,scenario.width,scenario.height);
          params = {
            // favour the json string if specified (used primarily for error testing)
            settingsJsonString: scenario.settingsString || scenario.settings
          };

          outerWrapper
            .css('width', scenario.width)
            .css('height', scenario.height)

          myWidgetDefinition.renderValue(container, params, myWidgetInstance);

        }).fail( function(error) {
          console.error("Download of ./resources/data/scenarios.json failed. Probably invalid JSON.");
          console.error(error);
          $('body').append($('<div>').text("Failure to download/parse ./resources/data/scenarios.json (probably invalid JSON). See dev tools console for error logging."));
        });
      });
    </script>

    <!-- TEMPLATE These are specific for your project and must be updated -->
    <script src="scripts/DisplayError.js"></script>
    <script src="scripts/Template.js"></script>
    <script src="scripts/rhtmlTemplate.js"></script>
  </body>
</html>
