<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="styles/main.css">
    <style type="text/css">

      .state-update-container {
        width: 800px;
      }

      .state-log-item {
        margin-bottom: 5px;
        padding-bottom: 5px;
        padding-left: 5px;
        background-color: lightblue;

      }
    </style>
  </head>
  <body>
    <!-- TEMPLATE These are specific for your project and must be updated -->
    <script src="external/lodash.min.js"></script>
    <script src="external/jquery.min.js"></script>
    <script src="external/d3.min.js"></script>

    <a href="/" class="prev-link" style="display:none">Prev</a>
    <a href="/">Back to Examples</a>
    <a href="/" class="next-link" style="display:none">Next</a>
    <h2 class="name" style="font-family:verdana"></h2>

    <div class="scenario" style="font-weight:600;font-family:verdana;padding-left:20px;"></div>

    <div class="outer-wrapper" style="padding-top:10px">
      <div class="content-window"></div>
    </div>

    <form id="resize-form" style="padding-top:10px" >
      <label for="width-input">New Width:</label>
      <input type="text" id="width-input" class="width-input" value="200"></input>
      <label for="height-input">New Height:</label>
      <input type="text" id="height-input" class="height-input" value="200"></input>
      <button class="resize-button">Resize</button>
    </form>

    <form id="set-state-form" style="padding-top:10px" >
      <label for="state-input">New State:</label>
      <input type="text" id="state-input" class="state-input" value=""></input>
      <button class="set-state-button">Set State</button>
    </form>

    <h3 style="font-family:verdana">Settings:</h2>
    <div class="config-container">
      <pre style="padding-left:20px" class="config"></pre>
    </div>

    <h3 style="font-family:verdana">State Updates:</h2>
    <div class="state-update-container">
    </div>


    <!-- NB This script should be defined before rhtmlTemplate.js is loaded-->
    <script>
    var DEFAULT_WIDTH = 600;
    var DEFAULT_HEIGHT = 600;

      function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
          }
        }
        console.log('Query variable %s not found', variable);
      }

      myWidgetDefinition = null;
      myWidgetInstance = null

      // This is a stub that will capture the widget definition,
      // so that we can use it once the page finishes loading
      HTMLWidgets = {
        widget: function(widgetDefinition) {
          console.log("widget create called!");
          myWidgetDefinition = widgetDefinition;
        }
      };

      $(document).ready( function() {
        console.log("Document ready. Fetching scenarios");

        $('#resize-form').bind('submit', function(event) {
          event.preventDefault();
          console.log("resize submit");

          width = $('#width-input').val();
          height = $('#height-input').val();

          outerWrapper = $('.outer-wrapper')
            .css('width', width)
            .css('height', height)

          container = $('.content-window')

          myWidgetDefinition.resize(container, width, height, myWidgetInstance);

          return false;
        });

        $('#set-state-form').bind('submit', function(event) {
          event.preventDefault();
          console.log("set state submit");

          newState = $('#state-input').val();

          //@TODO check if prototype has setState
          myWidgetInstance.setState(newState);

          return false;
        });

        var featureFileLocation = './resources/data/';
        var featureFile = getQueryVariable('featureFile') || 'features.json';

        $.ajax(featureFileLocation + featureFile).done(function (response) {
          console.log("Scenario retrieved. Instantiating captured widget");

          var featureIndex = parseInt(getQueryVariable('featureIndex'));
          var featureLength = response.features.length;
          var feature = response.features[featureIndex];

          var scenarioIndex = parseInt(getQueryVariable('scenarioIndex'));
          var scenarioLength = feature.scenarios.length;
          var scenario = feature.scenarios[scenarioIndex];

          getNext = function() {
            thereIsMoreScenarios = function () {
              return (scenarioIndex + 1 < scenarioLength);
            }

            thereIsMoreFeatures = function () {
              return (featureIndex + 1 < featureLength);
            }

            if (thereIsMoreScenarios()) {
              return {
                feature: featureIndex,
                scenario: scenarioIndex + 1
              }
            }

            else if (thereIsMoreFeatures()) {
              return {
                feature: featureIndex + 1,
                scenario: 0
              }
            }

            // NB wrap around case
            return {
              feature: 0,
              scenario: 0
            };
          }

          getPrev = function() {
            thereIsPreviousScenarios = function () {
              return (scenarioIndex > 0);
            }

            thereIsPreviousFeatures = function () {
              return (featureIndex > 0);
            }

            previousScenarioLength = function () {
              return response.features[featureIndex-1].scenarios.length - 1;
            }

            if (thereIsPreviousScenarios()) {
              return {
                feature: featureIndex,
                scenario: scenarioIndex - 1
              }
            }

            else if (thereIsPreviousFeatures()) {
              return {
                feature: featureIndex - 1,
                scenario: previousScenarioLength()
              }
            }

            //NB Wrap around case
            lastFeatureIndex = response.features.length - 1,
            lastFeature = response.features[lastFeatureIndex]
            lastScenarioIndex = lastFeature.scenarios.length - 1
            return {
              feature: lastFeatureIndex,
              scenario: lastScenarioIndex
            };
          }

          makeLink = function(args) {
            if (!args) { return null; }
            return 'render.html?featureIndex=' + args.feature + '&scenarioIndex=' + args.scenario;
          }

          prevLink = makeLink(getPrev());
          nextLink = makeLink(getNext());

          if (prevLink) {
            $('.prev-link').attr('href', prevLink).css('display', 'inline-block');
          }
          if (nextLink) {
            $('.next-link').attr('href', nextLink).css('display', 'inline-block');
          }

          $("body").keydown(function(e){
              var leftKey = 37;
              var rightKey = 39;
              if (prevLink && (e.keyCode || e.which) == leftKey) { window.location = prevLink; }
              if (nextLink && (e.keyCode || e.which) == rightKey) { window.location = nextLink; }
          });

          $('.name').text(scenario.name);
          _.forEach(scenario.description, function(descriptionLine) {
            textLine = $('<p>').text(descriptionLine);
            $('.scenario').append(textLine);
          });
          $('.config').text(JSON.stringify(scenario.config, {}, 2));

          outerWrapper = $('.outer-wrapper')
          container = $('.content-window')

          outerWrapper
            .css('width', scenario.config.width || DEFAULT_WIDTH)
            .css('height', scenario.config.height || DEFAULT_HEIGHT)

          myWidgetInstance = myWidgetDefinition.initialize(container, scenario.config.width, scenario.config.height);
          myWidgetInstance.registerStateListener(function(newState) {
            var logMessage = $('<div class="state-log-item">').html(JSON.stringify(newState, {}, 2));
            $('.state-update-container').append(logMessage);
          });

          myWidgetDefinition.renderValue(container, scenario.config, myWidgetInstance);

          if (scenario.initialState) { myWidgetInstance.setState(scenario.initialState); }

        }).fail( function(error) {
          console.error("Download of ./resources/data/scenarios.json failed. Probably invalid JSON.");
          console.error(error);
          $('body').append($('<div>').text("Failure to download/parse ./resources/data/scenarios.json (probably invalid JSON). See dev tools console for error logging."));
        });
      });
    </script>

    <!-- TEMPLATE These are specific for your project and must be updated -->
    <script src="scripts/DisplayError.js"></script>
    <script src="scripts/Template.js"></script>
    <script src="scripts/rhtmlTemplate.js"></script>
  </body>
</html>
